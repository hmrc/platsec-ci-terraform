version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - curl -sL https://deb.nodesource.com/setup_18.x | bash -
      - apt-get install -y nodejs jq
      - npm install -g renovate
  build:
    commands:
      - echo "Reading repositories from repos.json"
      - |
        # Loop through repositories and run Renovate
        success=true
        cat repos.json | jq -r '.repositories[] | "\(.org)/\(.repo)"' | while read repo; do
          echo "Running Renovate for $repo"
          renovate --platform github --token $GITHUB_TOKEN --repository $repo
          if [ $? -ne 0 ]; then
            echo "Renovate failed for $repo"
            success=false
          fi
        done
      - if [ "$success" = false ]; then exit 1; fi
  post_build:
    commands:
      - echo "Renovate process completed for all repositories."
      - |
        # Indicate whether Renovate succeeded or failed
        if [ "$success" = true ]; then
          echo "All repositories updated successfully!"
        else
          echo "One or more repositories failed to update."
        fi

